<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MJD-AI</title>
</head>
<body>
  <div id="overlay">
    <div id="confirmBox">
      <p>هل تريد حذف هذه المحادثة؟</p>
      <button onclick="confirmDelete(true)">نعم</button>
      <button onclick="confirmDelete(false)">إلغاء</button>
    </div>
  </div>

  <button id="menuBtn">☰</button>
  <div id="sidebar">
    <button id="newChat">🗨️</button>
    <div id="historyList"></div>
  </div>

  <h2>MJD-AI</h2>
  <div id="chatContainer"></div>

  <div id="inputBar">
    <textarea id="userInput" placeholder="اسئل MJD-AI ما تشاء"></textarea>
    <button id="sendBtn">➤</button>
  </div>
  
  <style>
  
  @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
* { box-sizing: border-box; }
body {
  margin: 0; font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #e0e0e0; height: 100vh; display: flex; flex-direction: column;
}
h2 {
  text-align: center; margin: 10px 0; font-size: 28px;
  color: #20e2ff; text-shadow: 0 0 10px #20e9ff;
}
#chatContainer {
  flex: 1; overflow-y: auto; padding: 10px 20px 90px;
}
.msg {
  max-width: 100%; width: 90%; margin: 10px;
  padding: 12px 18px; border-radius: 16px;
  word-wrap: break-word; white-space: pre-wrap;
  box-shadow: 0 0 4px #00e5ffaa inset;
  position: relative;
}
.ai {
  background-color: #1e2d3a;
  font-size: 16px;
  align-self: flex-end; text-align: right; color: #00e5ff;
}
.user {
  background-color: #203049;
  align-self: flex-start; text-align: left; color: #ffffff;
}

#inputBar {
  position: fixed; bottom: 0; width: 100%; background-color: #101b26;
  display: flex; justify-content: center; padding: 10px;
  box-shadow: 0 -2px 10px #000a; gap: 10px; z-index: 99;
}
textarea {
  width: 75%; height: 50px; resize: none; border-radius: 15px;
  border: none; padding: 12px; font-size: 16px;
  background: #1c2938; color: #fff;
  box-shadow: 0 0 6px #00e5ff88;
}
textarea:focus { outline: none; background-color: #32475d; }
button {
  width: 50px; height: 50px; border-radius: 50%; border: none;
  font-size: 22px; cursor: pointer;
  background: linear-gradient(90deg, #00bcd4, #006064);
  color: #fff; box-shadow: 0 0 10px #00e5ff88;
}
#menuBtn {
  position: fixed; top: 10px; right: 10px; z-index: 10000;
  font-size: 28px; background: none; box-shadow: none;
  background: linear-gradient(90deg, #00bcd4, #006064);
  width: 40px; height: 40px; display: flex;
  align-items: center; justify-content: center;
  margin-top: 5px;
}
#sidebar {
  position: fixed; top: 0; right: 0;
  width: 280px; height: 100%;
  background: #1a2733; padding: 20px;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  z-index: 999;
  overflow-y: auto;
}
#sidebar.active { transform: translateX(0%); }
.chatItem {
  background: #2c3e50; color: #00e5ff; padding: 10px;
  border-radius: 10px; margin-bottom: 10px; cursor: pointer;
  width
}
.chatItem:hover { background: #34495e; }
#newChat {
  margin-bottom: 15px; background: #00bcd4;
  border-radius: 50%; font-size: 18px;
  padding: 8px; margin-right: 200px;
  position: sticky;
  margin-top: -500px;
  z-index: 1000;
  height: 40px;
  width: 40px;
}
#overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4); display: none; z-index: 9900008;
}
#confirmBox {
  background: #243b55; color: white;
  width: 300px; margin: 200px auto;
  padding: 20px; border-radius: 10px;
  box-shadow: 0 0 10px #00e5ff88; text-align: center;
  z-index: 1000000;
}
#confirmBox button {
  margin: 10px; width: auto; border-radius: 10px;
  padding: 5px 20px; font-size: 16px;
}
  </style>

  <script>
  // عناصر DOM
const chatContainer = document.getElementById("chatContainer");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const sidebar = document.getElementById("sidebar");
const menuBtn = document.getElementById("menuBtn");
const historyList = document.getElementById("historyList");
const newChatBtn = document.getElementById("newChat");
const overlay = document.getElementById("overlay");

// متغيرات التطبيق
let messages = [];
let typing = false;
let deleteIndex = null;
let longPressTimer = null;

// رسالة النظام
const systemMessage = {
  role: "system",
  content: `أنت مساعد ذكي تمت برمجته يدويًا بالكامل من قبل المهندس أمجد.`
};

// حفظ المحادثة في localStorage
function saveChat() {
  const history = JSON.parse(localStorage.getItem("mjd-chat-histories") || "{}");
  const title = messages.find(m => m.role === "user")?.content?.slice(0, 20) || "بدون عنوان";
  history[title] = messages;
  localStorage.setItem("mjd-chat-histories", JSON.stringify(history));
  updateSidebar();
}

// تحميل محادثة معينة
function loadChat(msgs) {
  chatContainer.innerHTML = "";
  messages = msgs || [];
  messages.forEach(({ role, content }) => {
    addMessage(role, content);
  });
  sidebar.classList.remove("active");
}

// إضافة رسالة جديدة إلى واجهة المستخدم
function addMessage(role, content) {
  const msgDiv = document.createElement("div");
  msgDiv.className = `msg ${role === "user" ? "user" : "ai"}`;
  msgDiv.textContent = content;
  chatContainer.appendChild(msgDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// إرسال رسالة المستخدم
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text || typing) return;
  userInput.value = "";
  addMessage("user", text);
  messages.push({ role: "user", content: text });
  saveChat();

  sendBtn.textContent = "⏹️";
  typing = true;

  try {
    const res = await callLLMAPI(text);
    messages.push({ role: "assistant", content: res });
    await typeText(res);
    saveChat();
  } catch (err) {
    typeText("❌ حدث خطأ في الاتصال.");
  } finally {
    sendBtn.textContent = "➤";
    typing = false;
  }
}

// عرض النص بشكل متدرج (كتابة)
async function typeText(text) {
  let current = "";
  const chunk = document.createElement("div");
  chunk.className = "msg ai";
  chatContainer.appendChild(chunk);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  for (let i = 0; i < text.length; i++) {
    if (!typing) break;
    current += text[i];
    chunk.textContent = current;
    chatContainer.scrollTop = chatContainer.scrollHeight;
    await new Promise(res => setTimeout(res, 20));
  }
  if (!typing) chunk.textContent = text;
}

// استدعاء واجهة برمجة التطبيقات للذكاء الاصطناعي
async function callLLMAPI(message) {
  const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer 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"
    },
    body: JSON.stringify({
      model: "mistralai/devstral-small:free",
      messages: [systemMessage, ...messages, { role: "user", content: message }],
      temperature: 0.7
    })
  });

  const data = await response.json();
  return data.choices[0].message.content.trim();
}

// تحديث القائمة الجانبية للمحادثات السابقة
function updateSidebar() {
  historyList.innerHTML = "";
  const history = JSON.parse(localStorage.getItem("mjd-chat-histories") || "{}");
  Object.keys(history).forEach((title) => {
    const item = document.createElement("div");
    item.className = "chatItem";
    item.textContent = title;
    
    // معالجات أحداث الضغط المطول
    item.addEventListener('touchstart', (e) => {
      longPressTimer = setTimeout(() => {
        deleteIndex = title;
        overlay.style.display = "block";
      }, 1000);
    });
    
    item.addEventListener('touchend', () => {
      clearTimeout(longPressTimer);
    });
    
    item.addEventListener('mousedown', (e) => {
      longPressTimer = setTimeout(() => {
        deleteIndex = title;
        overlay.style.display = "block";
      }, 1000);
    });
    
    item.addEventListener('mouseup', () => {
      clearTimeout(longPressTimer);
    });
    
    item.addEventListener('mouseleave', () => {
      clearTimeout(longPressTimer);
    });
    
    item.onclick = (e) => {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      loadChat(history[title]);
    };
    
    historyList.appendChild(item);
  });
}

// تأكيد حذف المحادثة
function confirmDelete(yes) {
  if (yes && deleteIndex) {
    const history = JSON.parse(localStorage.getItem("mjd-chat-histories") || "{}");
    delete history[deleteIndex];
    localStorage.setItem("mjd-chat-histories", JSON.stringify(history));
    updateSidebar();
  }
  overlay.style.display = "none";
  deleteIndex = null;
}

// أحداث الأزرار
sendBtn.onclick = () => {
  if (typing) {
    typing = false;
    sendBtn.textContent = "➤";
  } else {
    sendMessage();
  }
};

menuBtn.onclick = () => sidebar.classList.toggle("active");

newChatBtn.onclick = () => {
  if (messages.length === 0) return;
  messages = [];
  chatContainer.innerHTML = "";
  saveChat();
  sidebar.classList.remove("active");
};


  // إغلاق القائمة الجانبية عند النقر خارجها
window.addEventListener("click", (e) => {
  if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
    sidebar.classList.remove("active");
  }
});

// تهيئة التطبيق
updateSidebar();

// إرسال الرسالة عند الضغط على Enter
userInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// تمكين إرسال الرسالة عند فقدان التركيز من حقل الإدخال
userInput.addEventListener("blur", () => {
  if (userInput.value.trim() !== "") {
    sendMessage();
  }
});

// تحسين تجربة المستخدم للهواتف المحمولة
document.addEventListener("touchstart", (e) => {
  if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
    sidebar.classList.remove("active");
  }
});

// إعادة تحميل المحادثات عند تغيير حجم النافذة
window.addEventListener("resize", () => {
  updateSidebar();
});

// تعطيل التمرير عند الكتابة لمنع التحركات غير المقصودة
userInput.addEventListener("focus", () => {
  document.body.style.overflow = "hidden";
});

userInput.addEventListener("blur", () => {
  document.body.style.overflow = "auto";
});

// تحسين الأداء للهواتف ذات الذاكرة المحدودة
let isScrolling;
chatContainer.addEventListener("scroll", () => {
  window.clearTimeout(isScrolling);
  isScrolling = setTimeout(() => {
    // تحسين الأداء أثناء التمرير
  }, 100);
});

// تهيئة أولية للرسائل إذا كانت فارغة
if (localStorage.getItem("mjd-chat-histories") === null) {
  localStorage.setItem("mjd-chat-histories", JSON.stringify({}));
  messages = [];
  addMessage("assistant", "مرحباً! أنا MJD-AI، كيف يمكنني مساعدتك اليوم؟");
  saveChat();
}

// تحسين إمكانية الوصول للأشخاص ذوي الإعاقة
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    sidebar.classList.remove("active");
    overlay.style.display = "none";
  }
});

// تحسين تجربة المستخدم للوحة المفاتيح
userInput.addEventListener("keydown", (e) => {
  if (e.key === "ArrowUp" && userInput.selectionStart === 0) {
    // عرض تاريخ الرسائل السابقة
  } else if (e.key === "ArrowDown" && 
             userInput.selectionEnd === userInput.value.length) {
    // عرض تاريخ الرسائل اللاحقة
  }
});

// تحسين الأداء للشبكات البطيئة
const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
if (connection) {
  if (connection.effectiveType === "slow-2g" || connection.effectiveType === "2g") {
    console.log("اتصال بطيء - تم تفعيل وضع التوفير");
    // يمكن إضافة تحسينات إضافية للشبكات البطيئة هنا
  }
}

// إضافة رسالة ترحيبية عند فتح التطبيق لأول مرة
window.addEventListener("load", () => {
  const history = JSON.parse(localStorage.getItem("mjd-chat-histories") || "{}");
  if (Object.keys(history).length === 0) {
    addMessage("assistant", "مرحباً بك في MJD-AI! كيف يمكنني مساعدتك اليوم؟");
    messages.push({
      role: "assistant",
      content: "مرحباً بك في MJD-AI! كيف يمكنني مساعدتك اليوم؟"
    });
    saveChat();
  }
});

// تحسين تجربة اللمس للأجهزة التي تدعم اللمس
if ('ontouchstart' in window) {
  document.body.classList.add("touch-device");
  chatContainer.style.webkitOverflowScrolling = "touch";
}

// تحسين الأداء للشاشات الكبيرة
const mediaQuery = window.matchMedia("(min-width: 1024px)");
if (mediaQuery.matches) {
  sidebar.style.width = "320px";
}

// إضافة تأثيرات بصرية إضافية
sendBtn.addEventListener("mousedown", () => {
  sendBtn.style.transform = "scale(0.9)";
});

sendBtn.addEventListener("mouseup", () => {
  sendBtn.style.transform = "scale(1)";
});

sendBtn.addEventListener("mouseleave", () => {
  sendBtn.style.transform = "scale(1)";
});
  </script>
</body>
    </html>
